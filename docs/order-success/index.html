<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

<link rel="stylesheet" href="./mystyle.css">

<title>รายการอาหาร</title> 

<script src="https://www.gstatic.com/firebasejs/4.5.0/firebase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom box-shadow mb-3">
    <div class="container-fluid">
        <a class="navbar-brand" href="/user-orders">เมนู</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-collapse collapse d-sm-inline-flex justify-content-between">
            <ul class="navbar-nav flex-grow-1">
                <li class="nav-item">
                    <a class="nav-link text-dark" href="/user-orders">สั่งอาหาร</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-dark" href="/user-orders/orders">รายการอาหาร</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-dark" href="/user-orders/order-success">รายการที่สำเร็จแล้ว</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
        <h5>สรุปยอด: <span id="summary_price"></span></h5>
    </div>
  </div>
  <div class="row" style="overflow-y: auto;">
      <div id="order-list" class="col-12 order-list" style="display: -webkit-box;">
       
      </div>
  </div>
</div>
<script>
    let dataList = [];
  $(document).ready(function(){
    console.log('hi script')
    getOrderInprogress();
  });


function ajaxCallPagePost(url, data) {
    return new Promise((resolve, reject) => {
        $.ajax({
            type: "POST",
            url: 'https://api-prod.letjoys.com' + url,
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            dataType: "json"
        }).done(function (data) {
            resolve(data);
        });
    });
}

function getOrderInprogress(){
    console.log('getOrderInprogress')
    let data = {
        id: 0,
        order_date: '2023-08-08',
        action: ''
    }
    console.log('data', data)
    ajaxCallPagePost('/api/orders/get', data).then((_data) => {
            if (_data.messageStatus === 'success') {
                console.log(_data)
                let summary_price = 0;
                let txt = '';
                _data.orders.forEach(element => {
                    summary_price += element.total_price;
                    let dt = JSON.parse(element.order_json);
                    console.log(dt)
                    txt += `<div class="me-3" style="width: 300px;"><div class="card p-3" style="">`;
                    txt += `<div class="text-end"><a class="" href="/user-orders?id=`+element.id+`">แก้ไข</a></div>`
                    txt += `<p>เวลา: `+(element.created_at)+`</p>`;
                    txt += `<p>โต๊ะ: `+(element.table_number === '' ? '-' : element.table_number)+`</p>`;
                        txt += `<table class="table" id="data_list_`+element.seq+`">
                  <thead>
                      <tr>
                          <th>รายการ</th>
                          <th class="text-center">จำนวน</th>
                          <th class="text-end">ราคา</th>
                      </tr>
                  </thead>
                  <tbody>`     
                    dt.forEach(element2 => {
                    if(element2.key2 === ''){
                            txt += `<tr>
                                    <td>`+element2.key1+`</td>
                                    <td class="text-center">`+element2.key_num+`</td>
                                    <td class="text-end">`+element2.key_sum_amount+`</td>
                                </tr>`;
                        }else{
                            txt += `<tr>
                                    <td>`+element2.key1+` / `+ element2.key2 +`<br/>`+element2.key3+`<br/>`+element2.key4+`<br/>`+element2.key5+`</td>
                                    <td class="text-center">`+element2.key_num+`</td>
                                    <td class="text-end">`+element2.key_sum_amount+`</td>
                                </tr>`;
                        }
                    

                      

                    });
                    txt +=  `</tbody>
                  <tfoot>
                      <tr>
                          <td></td>
                          <td colspan="1">รวม</td>
                          <td class="text-end" id="data_list_amount">`+element.total_price+`</td>
                      </tr>
                  </tfoot>
              </table>`;

              txt +=  `<div class='d-flex'>`;

              if(element.order_status === 'I'){
              txt += `<button class="btn btn-sm btn-success w-50" onclick="updateOrderStatus('S', `+element.id+`)">จัดส่ง</button>`;
              }else if(element.order_status === 'S'){
              txt += `<button class="btn btn-sm btn-secondary w-50" disabled>จัดส่งแล้ว</button>`;
              }
              if(element.paid_status === 'N'){
                txt += `<button class="btn btn-sm btn-warning w-50" onclick="updatePaidStatus('Y', `+element.id+`)">ชำระเงิน</button>`;

                }else{
              txt += `<button class="btn btn-sm btn-secondary w-50" disabled>ชำระแล้ว</button>`;

                }

                    txt +=  `</div>`;
                    txt +=  `</div></div>`;
                });

                $('#order-list').empty();
                $('#order-list').append(txt);
                $('#summary_price').text(summary_price);

                if(_data.orders.length === 0){
                    $('#order-list').append('ยังไม่มีรายการ');
                $('#summary_price').text('0');
                }
            } else {
                alert(_data.messageDescription);
                // showToastsWarningBottomEndFade(_data.messageDescription)
            }
        }).catch((error) => {
            console.log(error)
        }).finally(function () {
            // hideSpinnerBtn(getThis);
        });
}

function updateOrderStatus(status, id){
    let data = {
        id: id,
        action: 'order status',
        order_status: status
    }
    ajaxCallPagePost('/api/orders/update', data).then((_data) => {
            if (_data.messageStatus === 'success') {
                // alert('success');
                location.reload();
            } else {
                alert(_data.messageDescription);
                // showToastsWarningBottomEndFade(_data.messageDescription)
            }
        }).catch((error) => {
            console.log(error)
        }).finally(function () {
            // hideSpinnerBtn(getThis);
        });
}
function updatePaidStatus(status, id){
    let data = {
        id: id,
        action: 'paid status',
        paid_status: status
    }
    ajaxCallPagePost('/api/orders/update', data).then((_data) => {
            if (_data.messageStatus === 'success') {
                // alert('success');
                location.reload();
            } else {
                alert(_data.messageDescription);
                // showToastsWarningBottomEndFade(_data.messageDescription)
            }
        }).catch((error) => {
            console.log(error)
        }).finally(function () {
            // hideSpinnerBtn(getThis);
        });
}
</script>
